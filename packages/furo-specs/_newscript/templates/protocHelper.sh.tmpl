#! /bin/bash

if [ -z "$2" ]
then
  echo 'missing argument, package folder is required'
exit 1
fi
BUILDPATHPROTOS=$1
THEPROTOFILE=$2

if [ ! -d $BUILDPATHPROTOS ]
then
    echo "Package folder /$BUILDPATHPROTOS DOES NOT exists."
    exit 1
fi
# https://github.com/gogo/protobuf/issues/325
cd $BUILDPATHPROTOS


mkdir -p ../pb/
{{if .java}}mkdir -p ../java/{{end}}
{{if .swagger}}mkdir -p ../swagger/{{end}}

protoc --proto_path=./ \
-I. \
{{- range $import := .protoc_I}}
-I{{$import}} \{{end}}
--gogofast_out=.\
{{- range $m := .protoc_M}}
M{{$m}},\{{end}}
{{- range $m := .mod}}
M{{$m.file}}=../{{$m.package}},\{{end}}
plugins=grpc:../pb/ \
{{- if .swagger}}--swagger_out=logtostderr=true:../swagger/ \{{end}}
{{- if .java}}--java_out=../java/ \{{end}}
{{- if .grpc_gateway}}--grpc-gateway_out=logtostderr=true:../pb/ \{{end}}
$THEPROTOFILE
